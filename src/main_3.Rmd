---
title: "MATH60633A – TP2"
output: html_document
date: "April, 2025"
---

**Project 1: Asset Management**




### 3. Out-of-sample impact


```{r, message=FALSE, warning=FALSE}

library(dplyr)
library(tidyr)
library(ggplot2)
library(mvtnorm) 
library(MASS)    
library(RiskPortfolios) 
library(Matrix) 
library(zoo)
library(here)
library(fitHeavyTail) 
library(gt)
library(tidyverse)
library(PerformanceAnalytics)


source(here('src','core_functions.R'))
source(here('src','core_functions_2.R'))

set.seed(1234)

load(here("data", "FTSE_const_rets.rda"))
print(rets[1:5, 1:5])


```
#### 3.1 Out-of-sample performance analysis

In this section we select the first 25 equities in the data set in alphabetical order, the model is estimated on a 104-week look-back window, approximately 2 years. Each week we (i) compute the plain sample covariance of those 104 observations, (ii) form two long-only efficient portfolios, the minimum-variance portfolio and the maximum-diversification portfolio, and (iii) apply the resulting weights to the return of the next week. All subsequent weeks repeat this roll-forward procedure, so every out-of-sample (OOS) return is generated with information that was available at the time. In this set-up the minvar strategy delivers the smoothest out-of-sample rolling window volatility and the highest Sharpe ratio. The maxdiv strategy earns a lower average return and it shows higher volatility.


```{r, message=FALSE, warning=FALSE}

R25   <- prep_data(rets)  
oos   <- rolling_oos(R25)                          

oos_samp <- oos %>%                    
  filter(cov_est == "sample")  # keep sample estimator only for this analysis

oos_start <- min(oos_samp$week)         # first OOS week index

ann_fac <- sqrt(52)
perf_tbl <- oos_samp %>%
  group_by(portfolio) %>%
  summarise(
    mean_ret = mean(ret) * 52,               # annualised mean
    vol      = sd(ret)   * ann_fac,          # annualised vol
    sharpe   = mean_ret / vol,
    cum_ret  = prod(1 + ret) - 1,
    .groups = "drop"
  )

perf_tbl %>% mutate(across(where(is.numeric), ~round(.x, 4)))


aux <- oos_samp %>%
  arrange(week) %>%
  group_by(portfolio) %>%
  mutate(aux = cumprod(1 + ret)) %>%
  ungroup()

# Cumulative return
ggplot(aux, aes(week, aux, colour = portfolio)) +
  geom_line(size = 1) +
  geom_vline(xintercept = oos_start, colour = "black") +
  scale_colour_manual(values = c("minvar" = "steelblue",
                                 "maxdiv" = "firebrick"),
                      name = "Portfolio") +
  labs(title = "Cumulative return — sample covariance",
       subtitle = paste("Vertical bar = start of OOS (week", oos_start, ")"),
       x = "Week", y = "Wealth (start of OOS = 1)") +
  theme_minimal(base_size = 13)


# 52-week rolling volatility plot 
roll_vol <- aux %>%
  group_by(portfolio) %>%
  mutate(roll_vol = rollapply(ret, width = 52,
                              FUN = sd, fill = NA, align = "right") *
           ann_fac) %>%
  ungroup()
roll_vol <- na.omit(roll_vol)

ggplot(roll_vol, aes(week, roll_vol, colour = portfolio)) +
  geom_line(size = 1) +
  scale_colour_manual(values = c("minvar" = "steelblue",
                                 "maxdiv" = "firebrick"),
                      name = "Portfolio") +
  labs(title = "OOS rolling 52-week volatility — sample covariance",
       x = "Week", y = "Ann. volatility") +
  theme_minimal(base_size = 13)
```



#### 3.2 Out-of-sample performance and shrinkage approaches

Keeping the same rolling window and weekly re-balancing schedule, we now replace the noisy sample covariance with two shrinkage estimators: (i) Ledoit–Wolf linear shrinkage toward the identity matrix, and (ii) a 3-factor model whose covariance is shrunk toward the factor block. These are the same estimators we considered in section 2. Both estimators lift the smallest eigenvalues and lower the condition number. Out-of-sample this translates into visibly smoother return trajectories and lower volatility for both portfolios. 

The maxdiv portfolio benefits the most form the shrinkage approahces, its realized volatility drops markedly, pushing its Sharpe ratio above the minvar strategy. The table confirms that intuition. With the plain sample covariance the maxdiv strategy gives an annualized Sharpe of 0.055. Switching to Ledoit–Wolf lifts the mean return while volatility is virtually unchanged, so the Sharpe climbs to 0.072. The 3-factor shrinkage goes one step further: volatility drops by another 10–20 bp and the mean rises again, pushing the Sharpe to 0.078. For the minvar strategy the gains are smaller in percentage terms  but the pattern is the same.



```{r, message=FALSE, warning=FALSE}

ann_fac <- sqrt(52)                      
perf_tbl <- oos %>%
  group_by(portfolio, cov_est) %>%
  summarise(
    mean_ret = mean(ret),
    vol      = sd(ret),
    sharpe   = mean_ret / vol,
    cum_ret  = prod(1 + ret) - 1,
    .groups = "drop"
  ) %>%
  mutate(
    mean_ret = mean_ret * 52,            # annualise mean
    vol      = vol * ann_fac
  )
  
perf_tbl

# Cumulative return data 
aux <- oos %>%
  arrange(week) %>%
  group_by(portfolio, cov_est) %>%
  mutate(aux = cumprod(1 + ret)) %>%
  ungroup()

oos_start <- min(oos$week)              # first week in the OOS table

ggplot(aux,
       aes(x = week, y = aux, colour = cov_est)) +
  geom_line() +
  facet_wrap(~ portfolio, nrow = 2) +
  geom_vline(xintercept = oos_start, colour = "black", linetype = "solid") +
  scale_colour_brewer(palette = "Set1", name = "Covariance") +
  labs(title = "Cumulative return",
       subtitle = paste0("Vertical bar = start of OOS period (week ",
                         oos_start, ")"),
       x = "Week", y = "Wealth (start of OOS = 1)") +
  theme_minimal(base_size = 13)

# 52-week rolling volatility plot 
plot_rolling_vol <- function(oos_tbl) {
  oos_tbl %>%
    arrange(week) %>%
    group_by(portfolio, cov_est) %>%
    mutate(trail_vol = zoo::rollapply(ret, width = 52,
                                      FUN = sd, fill = NA, align = "right") * sqrt(52)) %>%
    filter(!is.na(trail_vol)) %>%
    ggplot(aes(week, trail_vol, colour = cov_est)) +
    geom_line() +
    facet_wrap(~ portfolio, nrow = 2) +
    scale_colour_brewer(palette = "Set1", name = "Cov estimator") +
    labs(title = "OOS rolling 52-week volatility",
         x = "Week", y = "Ann. volatility") +
    theme_minimal(base_size = 13) 
}


plot_rolling_vol(oos)   

```



#### 3.3 Out-of-sample performance and resampling approaches

In this subsection, instead of taming estimation error inside the covariance matrix, we address it at the portfolio construction step. For every weekly window we create 100 pseudo-samples based on iid bootstrap, a stationary block bootstrap, or a Gaussian parametric bootstrap. We optimise each replica, average the resulting weight vectors, and then invest those averaged weights for the next week to compute the out-of-sample statistics and compare the three resampling approaches.

Our results show that plug-in portfolios, built directly from the raw sample covariance without any resampling, carry the most estimation noise. This estimator has the highest 52-week‐volatility curves for nearly the entire out-of-sample window for both min-vol and max-div. For the maxdiv portfolios, resampling dampens those extremes, the stationary-block bootstrap and iid boostrap trims volatility the most in our sample. 


```{r, message=FALSE, warning=FALSE}

oos_res <- rolling_oos_resamp(R25)
oos_start <- min(oos_res$week)

oos_samp2 <- oos_samp %>%                    # <- you created earlier
  mutate(resample = "plugin")                # new column

#bind rows and set factor ordering
oos_all <- bind_rows(oos_res, oos_samp2) %>%  
  mutate(resample = factor(resample,
           levels = c("plugin","iid","block","gauss")))

ann_f <- sqrt(52)
perf_tbl <- oos_all %>%
  group_by(resample, portfolio) %>%
  summarise(
    mean    = mean(ret) * 52,
    vol     = sd(ret)   * ann_f,
    sharpe  = mean / vol,
    cum_ret = prod(1 + ret) - 1,
    .groups = "drop"
  ) %>%
  arrange(portfolio, resample)

perf_tbl


# Cumulative return
aux <- oos_all %>%
  arrange(week) %>%
  group_by(resample, portfolio) %>%
  mutate(aux = cumprod(1 + ret)) %>%
  ungroup()

ggplot(aux, aes(week, aux, colour = resample)) +
  geom_line(size = 1) +
  geom_vline(xintercept = oos_start, colour = "black") +
  facet_wrap(~ portfolio, nrow = 2, scales = "free_y") +
  scale_colour_brewer(palette = "Set1", name = "Estimator") +
  labs(title    = "Cumulative return",
       subtitle = paste("Vertical bar = start of OOS period (week", oos_start, ")"),
       x = "Week", y = "Wealth (start of OOS = 1)") +
  theme_minimal(base_size = 13) +
  theme(legend.position = "right",
        panel.grid.major.x = element_blank(),
        strip.background = element_blank())   # removes grey facet strip

# Rolling volatility 
roll_vol <- oos_all %>%
  arrange(week) %>%
  group_by(resample, portfolio) %>%
  mutate(rvol = zoo::rollapply(ret, 52, sd, fill = NA, align = "right") *
                 sqrt(52)) %>%
  ungroup()

cutoff <- oos_start + 52         
roll_vol_f <- roll_vol %>%
  filter(week >= cutoff)

ggplot(roll_vol_f, aes(week, rvol, colour = resample)) +
  geom_line(size = 1) +
  facet_wrap(~ portfolio, nrow = 2, scales = "free_y") +
  scale_colour_brewer(palette = "Set1", name = "Estimator") +
  labs(title = "OOS rolling 52-week volatility",
       x = "Week", y = "Ann. volatility") +
  theme_minimal(base_size = 13)


```










